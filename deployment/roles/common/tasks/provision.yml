---
- name: provision instance
  ec2: >
    aws_access_key={{ aws.access_key_id }}
    aws_secret_key={{ aws.secret_access_key }}
    count={{ instance_count }}
    region={{ aws.region }}
    keypair={{ aws.keypair }}
    group={{ aws.security_group }}
    instance_type={{ aws.instance_type }}
    image={{ aws.image }}
    wait=true
    instance_tags={{ aws.instance_tags }}
    vpc_subnet_id={{ aws.subnet_id }}
  register: ec2
- name: register host group
  add_host: >
    hostname={{ item.public_dns_name }}
    groupname=provisioned
  with_items: ec2.instances
- name: wait for instance boot
  pause: minutes=1
